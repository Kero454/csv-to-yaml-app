<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV to YAML Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .drop-zone {
            border: 2px dashed #4a90e2;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .drop-zone:hover, .drop-zone.drag-over {
            background-color: #f0f7ff;
            border-color: #2563eb;
        }
        .hidden {
            display: none;
        }
        .step {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">CSV to YAML Converter</h1>
            
            <!-- Step 1: Username Input -->
            <div id="step-username" class="step">
                <div class="mb-6">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Enter your username:</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., john_doe">
                </div>
                <div class="flex justify-end">
                    <button id="next-to-experiment" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Next</button>
                </div>
            </div>

            <!-- Step 2: Experiment Name Input -->
            <div id="step-experiment" class="step hidden">
                <div class="mb-6">
                    <label for="experiment" class="block text-sm font-medium text-gray-700 mb-2">Enter experiment name:</label>
                    <input type="text" id="experiment" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., experiment_1">
                </div>
                <div class="flex justify-between">
                    <button id="back-to-username" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">Back</button>
                    <button id="next-to-upload" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Next</button>
                </div>
            </div>

            <!-- Step 3: Upload CSV -->
            <div id="step-upload-csv" class="hidden space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Upload CSV File</h2>
                    <p class="text-gray-600 mb-4">Welcome, <span id="display-username" class="font-medium"></span>!<br>
                    Experiment: <span id="display-experiment" class="font-medium"></span></p>
                    
                    <!-- CSV Upload Section -->
                    <div class="mb-8">
                        <div id="csv-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50 transition-colors">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <p class="mt-2 text-sm text-gray-600">
                                <span class="font-medium text-blue-600">Click to upload</span> or drag and drop
                            </p>
                            <p class="text-xs text-gray-500 mt-1">CSV file only</p>
                            <p id="csv-file-name" class="text-sm text-gray-500 mt-2">No file selected</p>
                            <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                        </div>
                        <div id="csv-success-message" class="mt-2 text-sm text-green-600 hidden"></div>
                        <div id="csv-error-message" class="mt-2 text-sm text-red-600 hidden"></div>
                    </div>
                    
                    <!-- YAML Output Section -->
                    <div id="result" class="mt-8 bg-gray-50 p-4 rounded-lg hidden">
                        <h3 class="text-lg font-medium mb-2">YAML Configuration</h3>
                        <div class="bg-white p-4 rounded border border-gray-200 mb-4">
                            <pre id="yaml-output" class="text-sm text-gray-800 overflow-auto max-h-64"></pre>
                        </div>
                        <div class="flex space-x-2">
                            <button id="copy-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                                Copy to Clipboard
                            </button>
                            <a id="download-btn" href="#" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 hidden" download>
                                Download YAML
                            </a>
                        </div>
                    </div>
                    
                    <!-- Navigation Buttons -->
                    <div class="mt-6 flex justify-between">
                        <button id="back-to-experiment" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            ← Back to Experiment
                        </button>
                        <div class="space-x-2">
                            <button id="to-architecture-upload" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 hidden">
                                Continue to Architecture Upload →
                            </button>
                            <button id="reset-form" class="px-4 py-2 border border-red-300 text-red-600 rounded-md hover:bg-red-50">
                                Start Over
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Upload Architecture Files -->
            <div id="step-upload-architecture" class="hidden space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Upload Architecture Files</h2>
                    <p class="text-gray-600 mb-4">
                        <span class="font-medium">User:</span> <span id="display-username-arch"></span><br>
                        <span class="font-medium">Experiment:</span> <span id="display-experiment-arch"></span>
                    </p>
                    
                    <!-- Architecture Files Section -->
                    <div class="mb-8">
                        <p class="text-gray-600 mb-4">You can upload one or more architecture files (optional):</p>
                        <div id="architecture-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50 transition-colors">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="mt-2 text-sm text-gray-600">
                                <span class="font-medium text-blue-600">Click to upload</span> or drag and drop
                            </p>
                            <p class="text-xs text-gray-500 mt-1">One or more architecture files</p>
                            <div id="architecture-files-list" class="mt-2 text-sm text-gray-500"></div>
                            <input type="file" id="architecture-files-input" class="hidden" multiple>
                        </div>
                        <div class="mt-2">
                            <button id="upload-architecture-files" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Upload Selected Files
                            </button>
                        </div>
                        <div id="architecture-success-message" class="mt-2 text-sm text-green-600 hidden"></div>
                        <div id="architecture-error-message" class="mt-2 text-sm text-red-600 hidden"></div>
                    </div>
                    
                    <!-- Navigation Buttons -->
                    <div class="mt-6 flex justify-between">
                        <button id="back-to-csv-upload" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            ← Back to CSV Upload
                        </button>
                        <div class="space-x-2">
                            <button id="skip-architecture-upload" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                                Skip and Finish
                            </button>
                            <button id="reset-form-arch" class="px-4 py-2 border border-red-300 text-red-600 rounded-md hover:bg-red-50">
                                Start Over
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="error" class="hidden bg-red-50 border-l-4 border-red-400 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p id="error-message" class="text-sm text-red-700"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Form navigation elements
            const stepUsername = document.getElementById('step-username');
            const stepExperiment = document.getElementById('step-experiment');
            const stepUpload = document.getElementById('step-upload');
            
            const usernameInput = document.getElementById('username');
            const experimentInput = document.getElementById('experiment');
            
            const nextToExperimentBtn = document.getElementById('next-to-experiment');
            const backToUsernameBtn = document.getElementById('back-to-username');
            const nextToUploadBtn = document.getElementById('next-to-upload');
            const backToExperimentBtn = document.getElementById('back-to-experiment');
            
            const displayUsername = document.getElementById('display-username');
            const displayExperiment = document.getElementById('display-experiment');
            
            // CSV Upload Elements
            const csvDropZone = document.getElementById('csv-drop-zone');
            const csvFileInput = document.getElementById('csv-file-input');
            const csvFileName = document.getElementById('csv-file-name');
            const csvErrorMessage = document.getElementById('csv-error-message');
            const csvSuccessMessage = document.getElementById('csv-success-message');
            
            // Architecture Files Upload Elements
            const architectureDropZone = document.getElementById('architecture-drop-zone');
            const architectureFilesInput = document.getElementById('architecture-files-input');
            const architectureFilesList = document.getElementById('architecture-files-list');
            const uploadArchitectureBtn = document.getElementById('upload-architecture-files');
            const architectureErrorMessage = document.getElementById('architecture-error-message');
            const architectureSuccessMessage = document.getElementById('architecture-success-message');
            
            // Result Elements
            const resultDiv = document.getElementById('result');
            const yamlOutput = document.getElementById('yaml-output');
            const copyBtn = document.getElementById('copy-btn');
            const downloadBtn = document.getElementById('download-btn');
            
            // State
            let currentUsername = '';
            let currentExperiment = '';
            let architectureFiles = [];
            let currentYamlFile = null;

            // Step 1: Next button (Username -> Experiment)
            nextToExperimentBtn.addEventListener('click', function() {
                const username = usernameInput.value.trim();
                if (!username) {
                    alert('Please enter a username');
                    return;
                }
                currentUsername = username;
                stepUsername.classList.add('hidden');
                stepExperiment.classList.remove('hidden');
            });

            // Step 2: Back button (Experiment -> Username)
            backToUsernameBtn.addEventListener('click', function() {
                stepExperiment.classList.add('hidden');
                stepUsername.classList.remove('hidden');
            });

            // Step 2: Next button (Experiment -> Upload)
            nextToUploadBtn.addEventListener('click', function() {
                const experiment = experimentInput.value.trim();
                if (!experiment) {
                    alert('Please enter an experiment name');
                    return;
                }
                currentExperiment = experiment;
                displayUsername.textContent = currentUsername;
                displayExperiment.textContent = currentExperiment;
                stepExperiment.classList.add('hidden');
                stepUpload.classList.remove('hidden');
                
                // Reset any previous uploads
                resetUploadSections();
            });

            // Back to experiment from upload
            if (backToExperimentBtn) {
                backToExperimentBtn.addEventListener('click', function() {
                    stepUpload.classList.add('hidden');
                    stepExperiment.classList.remove('hidden');
                });
            }

            // Reset form
            if (resetFormBtn) {
                resetFormBtn.addEventListener('click', function() {
                    usernameInput.value = '';
                    experimentInput.value = '';
                    currentUsername = '';
                    currentExperiment = '';
                    
                    resetUploadSections();
                    
                    stepUpload.classList.add('hidden');
                    stepExperiment.classList.add('hidden');
                    stepUsername.classList.remove('hidden');
                });
            }
            
            // Handle CSV file upload
            function handleCsvFile(file) {
                if (!file.name.endsWith('.csv')) {
                    showError(csvErrorMessage, 'Please upload a CSV file');
                    return;
                }
                
                // Show file name with new naming convention
                if (csvFileName) {
                    const experiment = experimentInput.value.trim().toLowerCase();
                    csvFileName.textContent = `Original: ${file.name} → Will be saved as: ${experiment}.csv`;
                }
                
                // Upload the CSV file
                uploadCsvFile(file);
            }
            
            // Upload CSV file to server
            function uploadCsvFile(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('username', currentUsername);
                formData.append('experiment', currentExperiment);
                
                // Show loading state
                if (csvSuccessMessage) {
                    csvSuccessMessage.textContent = 'Uploading file...';
                    csvSuccessMessage.classList.remove('hidden');
                    if (csvErrorMessage) csvErrorMessage.classList.add('hidden');
                }
                
                // Disable file input during upload
                if (csvFileInput) csvFileInput.disabled = true;
                
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Upload failed'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Show YAML result
                    if (yamlOutput) yamlOutput.textContent = data.yaml || 'No content';
                    if (resultDiv) resultDiv.classList.remove('hidden');
                    
                    // Show success message for CSV upload
                    if (csvSuccessMessage) {
                        csvSuccessMessage.textContent = 'CSV file processed successfully. YAML configuration generated.';
                        csvSuccessMessage.classList.remove('hidden');
                        if (csvErrorMessage) csvErrorMessage.classList.add('hidden');
                    }
                    
                    // Store the YAML file path for download
                    currentYamlFile = data.download_url || null;
                    if (downloadBtn && currentYamlFile) {
                        downloadBtn.href = currentYamlFile;
                        downloadBtn.classList.remove('hidden');
                    }
                    
                    // Show the continue button to proceed to architecture upload
                    const toArchUploadBtn = document.getElementById('to-architecture-upload');
                    if (toArchUploadBtn) {
                        toArchUploadBtn.classList.remove('hidden');
                    }
                    
                    // Show back and reset buttons
                    if (backToExperimentBtn) backToExperimentBtn.classList.remove('hidden');
                    if (resetFormBtn) resetFormBtn.classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError(csvErrorMessage, error.message || 'Failed to process CSV file');
                })
                .finally(() => {
                    // Re-enable file input
                    if (csvFileInput) csvFileInput.disabled = false;
                });
            }
            
            // Handle architecture files selection
            function handleArchitectureFiles(files) {
                if (!files || files.length === 0) return;
                
                architectureFiles = Array.from(files);
                
                // Update UI to show selected files
                if (architectureFilesList) {
                    if (files.length === 1) {
                        architectureFilesList.innerHTML = `
                            <div class="flex items-center">
                                <svg class="h-4 w-4 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                ${files[0].name}
                            </div>`;
                    } else {
                        architectureFilesList.innerHTML = `
                            <div class="font-medium mb-1">Selected ${files.length} files:</div>
                            <div class="space-y-1 max-h-24 overflow-y-auto">
                                ${Array.from(files).map(file => `
                                    <div class="flex items-center">
                                        <svg class="h-3 w-3 mr-2 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        <span class="truncate">${file.name}</span>
                                    </div>`
                                ).join('')}
                            </div>`;
                    }
                }
                
                // Enable upload button
                if (uploadArchitectureBtn) {
                    uploadArchitectureBtn.disabled = false;
                }
                
                // Hide any previous messages
                if (architectureSuccessMessage) architectureSuccessMessage.classList.add('hidden');
                if (architectureErrorMessage) architectureErrorMessage.classList.add('hidden');
            }
            
            // Upload architecture files to server
            function uploadArchitectureFiles() {
                return new Promise((resolve) => {
                    if (architectureFiles.length === 0) {
                        resolve(false);
                        return;
                    }
                    
                    const formData = new FormData();
                    architectureFiles.forEach((file, index) => {
                        formData.append('files[]', file);
                    });
                    formData.append('username', currentUsername);
                    formData.append('experiment', currentExperiment);
                    
                    // Show loading state
                    if (uploadArchitectureBtn) {
                        uploadArchitectureBtn.disabled = true;
                        uploadArchitectureBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Uploading...';
                    }
                    
                    if (architectureSuccessMessage) {
                        architectureSuccessMessage.textContent = 'Uploading files...';
                        architectureSuccessMessage.classList.remove('hidden');
                        if (architectureErrorMessage) architectureErrorMessage.classList.add('hidden');
                    }
                    
                    fetch('/upload/architecture', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.error || 'Upload failed'); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Show success message
                        if (architectureSuccessMessage) {
                            architectureSuccessMessage.textContent = `Successfully uploaded ${data.uploaded_count || 0} architecture file(s).`;
                            architectureSuccessMessage.classList.remove('hidden');
                            if (architectureErrorMessage) architectureErrorMessage.classList.add('hidden');
                        }
                        
                        // Reset file input and list
                        architectureFiles = [];
                        if (architectureFilesInput) architectureFilesInput.value = '';
                        if (architectureFilesList) architectureFilesList.innerHTML = '';
                        
                        // Reset upload button
                        if (uploadArchitectureBtn) {
                            uploadArchitectureBtn.disabled = true;
                            uploadArchitectureBtn.textContent = 'Upload Selected Files';
                        }
                        
                        resolve(true);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showError(architectureErrorMessage, error.message || 'Failed to upload architecture files');
                        
                        // Re-enable upload button on error
                        if (uploadArchitectureBtn) {
                            uploadArchitectureBtn.disabled = false;
                            uploadArchitectureBtn.textContent = 'Upload Selected Files';
                        }
                        
                        resolve(false);
                    });
                });
            }
            
            // Show error message in the specified element
            function showError(element, message) {
                if (!element) return;
                element.textContent = message;
                element.classList.remove('hidden');
                
                // Auto-hide error after 5 seconds
                setTimeout(() => {
                    element.classList.add('hidden');
                }, 5000);
            }
            
            // Initialize drag and drop for CSV upload
            setupDropZone(csvDropZone, csvFileInput, (files) => {
                if (files.length > 0) {
                    handleCsvFile(files[0]);
                }
            });
            
            // Initialize drag and drop for Architecture files upload
            setupDropZone(architectureDropZone, architectureFilesInput, (files) => {
                if (files.length > 0) {
                    handleArchitectureFiles(files);
                }
            });
            
            // Handle CSV file selection via button
            if (csvFileInput) {
                csvFileInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        handleCsvFile(this.files[0]);
                    }
                });
            }
            
            // Handle Architecture files selection via button
            if (architectureFilesInput) {
                architectureFilesInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        handleArchitectureFiles(this.files);
                    }
                });
            }
            
            // Handle navigation to architecture upload step
            const toArchitectureUploadBtn = document.getElementById('to-architecture-upload');
            if (toArchitectureUploadBtn) {
                toArchitectureUploadBtn.addEventListener('click', function() {
                    document.getElementById('step-upload-csv').classList.add('hidden');
                    document.getElementById('step-upload-architecture').classList.remove('hidden');
                    
                    // Update the display in the architecture upload step
                    document.getElementById('display-username-arch').textContent = currentUsername;
                    document.getElementById('display-experiment-arch').textContent = currentExperiment;
                });
            }
            
            // Handle back to CSV upload step
            const backToCsvUploadBtn = document.getElementById('back-to-csv-upload');
            if (backToCsvUploadBtn) {
                backToCsvUploadBtn.addEventListener('click', function() {
                    document.getElementById('step-upload-architecture').classList.add('hidden');
                    document.getElementById('step-upload-csv').classList.remove('hidden');
                });
            }
            
            // Handle skip architecture upload
            const skipArchitectureUploadBtn = document.getElementById('skip-architecture-upload');
            if (skipArchitectureUploadBtn) {
                skipArchitectureUploadBtn.addEventListener('click', function() {
                    // Show a success message
                    alert('Your files have been processed successfully!');
                    // Reset the form
                    resetForm();
                });
            }
            
            // Handle reset from architecture step
            const resetFormArchBtn = document.getElementById('reset-form-arch');
            if (resetFormArchBtn) {
                resetFormArchBtn.addEventListener('click', resetForm);
            }
            
            // Handle Architecture files upload button
            if (uploadArchitectureBtn) {
                uploadArchitectureBtn.addEventListener('click', function() {
                    uploadArchitectureFiles().then(success => {
                        if (success) {
                            // After successful upload, change the skip button to 'Finish'
                            const skipBtn = document.getElementById('skip-architecture-upload');
                            if (skipBtn) {
                                skipBtn.textContent = 'Finish';
                            }
                        }
                    });
                });
            }
            
            // Handle copy to clipboard
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    if (!yamlOutput) return;
                    
                    const text = yamlOutput.textContent;
                    navigator.clipboard.writeText(text).then(function() {
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = 'Copied!';
                        copyBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                        copyBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                        
                        setTimeout(function() {
                            copyBtn.textContent = originalText;
                            copyBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                            copyBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                        }, 2000);
                    }).catch(function() {
                        alert('Failed to copy text');
                    });
                });
            }
            
            // Set up a drop zone with drag and drop functionality
            function setupDropZone(dropZone, fileInput, onFilesSelected) {
                if (!dropZone || !fileInput) return;
                
                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });

                // Highlight drop zone when item is dragged over it
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => highlight(dropZone), false);
                });

                // Remove highlight when item leaves drop zone
                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => unhighlight(dropZone), false);
                });

                // Handle dropped files
                dropZone.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    if (files.length > 0) {
                        onFilesSelected(files);
                    }
                }, false);
                
                // Handle click on drop zone to open file dialog
                dropZone.addEventListener('click', () => fileInput.click(), false);
            }
            
            // Reset all upload sections to their initial state
            function resetUploadSections() {
                // Reset CSV section
                if (csvFileInput) {
                    csvFileInput.value = '';
                    csvFileInput.disabled = false;
                }
                if (csvFileName) csvFileName.textContent = 'No file selected';
                if (csvSuccessMessage) csvSuccessMessage.classList.add('hidden');
                if (csvErrorMessage) csvErrorMessage.classList.add('hidden');
                
                // Reset Architecture section
                architectureFiles = [];
                if (architectureFilesInput) architectureFilesInput.value = '';
                if (architectureFilesList) architectureFilesList.innerHTML = '';
                if (uploadArchitectureBtn) {
                    uploadArchitectureBtn.disabled = true;
                    uploadArchitectureBtn.textContent = 'Upload Selected Files';
                }
                if (architectureSuccessMessage) architectureSuccessMessage.classList.add('hidden');
                if (architectureErrorMessage) architectureErrorMessage.classList.add('hidden');
                
                // Reset result section
                if (resultDiv) resultDiv.classList.add('hidden');
                if (yamlOutput) yamlOutput.textContent = '';
                if (downloadBtn) downloadBtn.classList.add('hidden');
                
                // Hide the continue to architecture upload button
                const toArchUploadBtn = document.getElementById('to-architecture-upload');
                if (toArchUploadBtn) {
                    toArchUploadBtn.classList.add('hidden');
                }
                
                // Show the first step (username)
                document.getElementById('step-upload-csv').classList.add('hidden');
                document.getElementById('step-upload-architecture').classList.add('hidden');
                document.getElementById('step-username').classList.remove('hidden');
                
                // Reset form fields
                if (usernameInput) usernameInput.value = '';
                if (experimentInput) experimentInput.value = '';
                currentUsername = '';
                currentExperiment = '';
                
                // Reset any error messages
                document.querySelectorAll('.error-message').forEach(el => {
                    el.textContent = '';
                    el.classList.add('hidden');
                });
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight() {
                if (dropZone) dropZone.classList.add('drag-over');
            }

            function unhighlight() {
                if (dropZone) dropZone.classList.remove('drag-over');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            // Handle file selection via button
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    handleFiles(this.files);
                });
            }

            function handleFiles(files) {
                if (!files || files.length === 0) return;
                
                const file = files[0];
                if (!file.name.endsWith('.csv')) {
                    alert('Please upload a CSV file');
                    return;
                }
                
                currentFile = file;
                
                // Show file name with new naming convention
                if (document.getElementById('file-name')) {
                    const experiment = document.getElementById('experiment').value.trim().toLowerCase();
                    document.getElementById('file-name').textContent = `Original: ${file.name} → Will be saved as: ${experiment}.csv`;
                }
                
                // Show loading state
                if (resultDiv) {
                    resultDiv.classList.add('hidden');
                }
                
                // Upload file with username and experiment
                const formData = new FormData();
                formData.append('file', file);
                formData.append('username', currentUsername);
                formData.append('experiment', currentExperiment);
                
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Upload failed'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    if (yamlOutput) yamlOutput.textContent = data.yaml || 'No content';
                    if (resultDiv) resultDiv.classList.remove('hidden');
                    if (downloadLink) downloadLink.href = data.download_url || '#';
                    
                    // Show success message with new filenames
                    if (successMessage) {
                        const experiment = document.getElementById('experiment').value.trim();
                        successMessage.innerHTML = `
                            Successfully processed files:<br>
                            - CSV saved as: <strong>${experiment}.csv</strong><br>
                            - YAML saved as: <strong>config_${experiment}.yaml</strong>
                        `;
                        successMessage.classList.remove('hidden');
                        if (errorMessage) errorMessage.classList.add('hidden');
                    }
                    
                    // Show back and reset buttons
                    if (backToExperimentBtn) backToExperimentBtn.classList.remove('hidden');
                    if (resetFormBtn) resetFormBtn.classList.remove('hidden');
                    
                    // Scroll to result
                    if (resultDiv) resultDiv.scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Show error message
                    if (errorMessage) {
                        errorMessage.textContent = 'Error: ' + (error.message || 'Failed to process file');
                        errorMessage.classList.remove('hidden');
                        if (successMessage) successMessage.classList.add('hidden');
                    }
                    if (resultDiv) resultDiv.classList.remove('hidden');
                });
            }

            // Copy to clipboard
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    if (!yamlOutput) return;
                    
                    const text = yamlOutput.textContent;
                    navigator.clipboard.writeText(text).then(function() {
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = 'Copied!';
                        copyBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                        copyBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                        
                        setTimeout(function() {
                            copyBtn.textContent = originalText;
                            copyBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                            copyBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                        }, 2000);
                    }).catch(function() {
                        alert('Failed to copy text');
                    });
                });
            }
        });
        
        function showError(message) {
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
        }
    </script>
</body>
</html>
